<!-- Seleção de métrica -->
<div class="controls">
  <div class="custom-select" (click)="toggleMetricOptions()">
    <span>{{ getMetricLabel(metric) }}</span>
    @if (showMetricOptions) {
      <ul class="options">
        @for (field of numericFields; track field) {
          <li
            (click)="selectMetric(field); $event.stopPropagation()"
            (touchstart)="selectMetric(field)"
            [class.active]="metric === field">
            {{ getMetricLabel(field) }}
          </li>
        }
      </ul>
    }
  </div>

  <div class="custom-select" (click)="togglePeriodOptions()">
    <span>{{ selectedPeriod }}</span>
    @if (showPeriodOptions) {
      <ul class="options">
        @for (period of periodOptions; track period) {
          <li
            (click)="selectPeriod(period); $event.stopPropagation()"
            (touchstart)="selectPeriod(period)"
            [class.active]="selectedPeriod === period">
            {{ period }}
          </li>
        }
      </ul>
    }
  </div>
</div>

<div class="chart-container">
  <div class="chart-scroll">
    <svg
      [attr.width]="svgWidth"
      [attr.height]="svgHeight"
      [attr.viewBox]="'0 0 ' + svgWidth + ' ' + svgHeight"
      class="chart-svg"
      (mouseleave)="hideTooltip()">

      <!-- Eixo Y -->
      <line
        [attr.x1]="MARGIN.left"
        [attr.y1]="MARGIN.top"
        [attr.x2]="MARGIN.left"
        [attr.y2]="svgHeight - MARGIN.bottom"
        stroke="#ccc" />

      <!-- Eixo X -->
      <line
        [attr.x1]="MARGIN.left"
        [attr.y1]="svgHeight - MARGIN.bottom"
        [attr.x2]="xAxisEnd"
        [attr.y2]="svgHeight - MARGIN.bottom"
        stroke="#ccc" />

      <!-- Labels do eixo Y -->
      @for (i of [0, 25, 50, 75, 100]; track i) {
        <text
          [attr.x]="MARGIN.left - 5"
          [attr.y]="svgHeight - MARGIN.bottom - i * 2"
          text-anchor="end"
          font-size="10"
          fill="#666">
          {{ i }}%
        </text>

        @if (i > 0) {
          <text
            [attr.x]="MARGIN.left - 5"
            [attr.y]="svgHeight - MARGIN.bottom + 15 - i * 2"
            text-anchor="end"
            font-size="9"
            fill="#999">
            {{ formatGoalValue(i / 100) }}
          </text>
        }
      }

      <!-- Labels do eixo X (rarificados) -->
      @for (item of animatedData; track $index) {
        @if (shouldShowXLabel($index)) {
          <text
            [attr.x]="xPos($index)"
            [attr.y]="svgHeight - MARGIN.bottom + 20"
            text-anchor="middle"
            [attr.font-size]="xLabelFontSize"
            fill="#333">
            {{ formatDate(item.date) }}
          </text>
        }
      }

      <!-- Linha -->
      <polyline
        fill="none"
        [attr.stroke]="colors[metric]"
        [attr.stroke-width]="strokeWidth"
        [attr.d]="getLinePath(animatedData, metric)" />

      <!-- Pontos -->
      @for (item of animatedData; track $index) {
        <circle
          [attr.cx]="xPos($index)"
          [attr.cy]="getYCoord(getValue(item, metric), goals[metric])"
          [attr.r]="pointRadius"
          [attr.fill]="colors[metric]"
          class="has-tooltip"
          (mouseenter)="onPointHover($event, item, $index)"
          (mouseleave)="hideTooltip()"
          (click)="onPointClick(item, $event)"
          (touchstart)="onPointClick(item, $event)" />
      }
    </svg>
  </div>

  <!-- Tooltip flutuante -->
  @if (showTooltip) {
    <div
      class="chart-tooltip"
      #tooltip
      [style.left.px]="tooltipX"
      [style.top.px]="tooltipY">
      {{ tooltipText }}
    </div>
  }

  @if (showHistoricalPopup) {
    <div class="popup-overlay" (click)="showHistoricalPopup = false">
      <div class="popup" (click)="$event.stopPropagation()">
        <h3 i18n>Alimentos – {{ historicalDate }}</h3>

        @if (hasHistoricalFoods) {
          <ul class="food-list">
            @for (food of historicalFoods; track $index) {
              <li>
                {{ food.description }}
                — {{ food.grams }} g
              </li>
            }
          </ul>
        } @else {
          <p style="margin-top: 1rem;">Nenhum alimento registrado nesse dia.</p>
        }

        <button (click)="showHistoricalPopup = false" i18n>Fechar</button>
      </div>
    </div>
  }
</div>
