<!-- Seleção de métrica -->
<div class="controls">
    <select [(ngModel)]="metric" (change)="onMetricChange()" class="metric-select">
        <option value="calorias" i18n>
            Calorias
        </option>
        <option value="proteinas" i18n>
            Proteínas
        </option>
        <option value="carbo" i18n>
            Carbo
        </option>
        <option value="gordura" i18n>
            Gordura
        </option>
    </select>

    <select [(ngModel)]="selectedPeriod" (change)="loadHistory()" class="period-select">
        <option value="7 dias" i18n>
            7 dias
        </option>
        <option value="1 mês" i18n>
            1 mês
        </option>
        <option value="3 meses" i18n>
            1 trimestre
        </option>
        <option value="6 meses" i18n>
            1 semestre
        </option>
        <option value="1 ano" i18n>
            1 ano
        </option>
    </select>
</div>

<div class="chart-container">
    <div class="chart-scroll">
        <svg width="3000" height="400" viewBox="0 0 2800 300" class="chart-svg" (mouseleave)="hideTooltip()">
            <!-- Eixos -->
            <line [attr.x1]="50" [attr.y1]="20" [attr.x2]="50" [attr.y2]="250" stroke="#ccc" />
            <line [attr.x1]="50" [attr.y1]="250" [attr.x2]="680" [attr.y2]="250" stroke="#ccc" />
    
            <!-- Labels do eixo Y -->
            @for (i of [0, 25, 50, 75, 100]; track i) {
                <text [attr.x]="45" [attr.y]="250 - i * 2" text-anchor="end" font-size="10" fill="#666">
                    {{ i }}%
                </text>
    
                <!-- Label secundária com valor absoluto -->
                @if (i > 0) {
                    <text [attr.x]="45" [attr.y]="265 - i * 2" text-anchor="end" font-size="9" fill="#999">
                    {{ formatGoalValue(i / 100) }}
                    </text>
                }
            }
    
            <!-- Labels do eixo X -->
            @for (item of animatedData; track $index) {
                <text 
                    [attr.x]="65 + $index * pointSpacing"
                    [attr.y]="270"
                    text-anchor="middle"
                    font-size="12"
                    fill="#333">
                    {{ formatDate(item.date) }}
                </text>
            }
    
            <!-- Linha única -->
            <polyline fill="none" [attr.stroke]="colors[metric]" stroke-width="3"
                [attr.d]="getLinePath(animatedData, metric)" />
                @for (item of animatedData; track $index) {
                    <circle 
                        [attr.cx]="65 + $index * pointSpacing"
                        [attr.cy]="getYCoord(getValue(item, metric), goals[metric])"
                        r="6"
                        [attr.fill]="colors[metric]"
                        class="has-tooltip"
                        (mouseenter)="onPointHover($event, item, $index)"
                        (mouseleave)="hideTooltip()"
                        (click)="openHistoricalFoodPopup(item)"
                    />
                }
        </svg>
    </div>

    <!-- Tooltip flutuante -->
    @if (showTooltip) {
        <div 
            class="chart-tooltip" 
            #tooltip 
            [style.left.px]="tooltipX" 
            [style.top.px]="tooltipY">
            {{ tooltipText }}
        </div>
    }
    @if (showHistoricalPopup) {
    <div class="popup-overlay" (click)="showHistoricalPopup = false">
        <div class="popup" (click)="$event.stopPropagation()">
        <h3 i18n>Alimentos – {{ historicalDate }}</h3>
        <ul class="food-list">
            @for (food of historicalFoods; track $index) {
            <li>{{ food.description }} — {{ food.grams }}g ({{ food.calories }} kcal)</li>
            }
        </ul>
        <button (click)="showHistoricalPopup = false" i18n>Fechar</button>
        </div>
    </div>
    }
</div>