<!-- Controles -->
<div class="controls">
  <div class="custom-select" (click)="showMetricOptions = !showMetricOptions">
    <span>{{ { calorias: 'Calorias', proteinas: 'Proteínas', carbo: 'Carbo', gordura: 'Gordura' }[metric] }}</span>
    @if (showMetricOptions) {
      <ul class="options">
        @for (field of numericFields; track field) {
          <li
            (click)="onSelectMetric(field)"
            (touchstart)="onSelectMetric(field)"
            [class.active]="metric === field">
            {{ { calorias: 'Calorias', proteinas: 'Proteínas', carbo: 'Carbo', gordura: 'Gordura' }[field] }}
          </li>
        }
      </ul>
    }
  </div>

  <div class="custom-select" (click)="showPeriodOptions = !showPeriodOptions">
    <span>{{ selectedPeriod }}</span>
    @if (showPeriodOptions) {
      <ul class="options">
        @for (period of periodOptions; track period) {
          <li
            (click)="selectPeriod(period); showPeriodOptions = false; $event.stopPropagation()"
            [class.active]="selectedPeriod === period">
            {{ period }}
          </li>
        }
      </ul>
    }
  </div>
</div>

<!-- Container: eixo Y fixo + área rolável só do gráfico -->
<div class="chart-container">
  <!-- Eixo Y fixo -->
  <div class="y-axis">
    <svg class="y-axis-svg" width="60" height="300" viewBox="0 0 60 300" aria-hidden="true">
      <line x1="50" y1="20" x2="50" y2="250" stroke="#ccc" />
      @for (i of [0, 25, 50, 75, 100]; track i) {
        <text
          [attr.x]="45"
          [attr.y]="tickY(i)"
          text-anchor="end"
          font-size="10"
          fill="#666">
          {{ i }}%
        </text>
        <!-- rótulo de valor + unidade para o tick -->
        <text
          [attr.x]="45"
          [attr.y]="tickY(i) + 12"
          text-anchor="end"
          font-size="9"
          fill="#999">
          {{ getYAxisTickLabel(i) }}
        </text>
      }
    </svg>
  </div>

  <!-- Só o gráfico rola lateralmente (sem linhas; apenas pontos) -->
  <div class="chart-scroll" [style.maxWidth.px]="viewportWidth">
    <svg
      [style.width.px]="getSvgPixelWidth()"
      height="300"
      viewBox="0 0 700 300"
      class="chart-svg"
      (mouseleave)="hideTooltip()"
    >
      <!-- Labels do eixo X -->
      @for (item of animatedData; track $index) {
        <text
          [attr.x]="getXLabel($index, animatedData.length, item)"
          [attr.y]="270"
          text-anchor="middle"
          font-size="12"
          fill="#333"
          class="x-label"
          (click)="onPointClick(item, $event)">
          {{
            item.__meta?.kind === 'weekly'
              ? getWeekIndexLabel($index)
              : (item.__meta?.kind === 'monthly' ? formatMonthLabel(item) : formatDate(item.date))
          }}
        </text>
      }

      <!-- Pontos -->
      @for (item of animatedData; track $index) {
        <circle
          [attr.cx]="getX($index, animatedData.length)"
          [attr.cy]="getYCoord(getRenderValue($index), getGoalForPoint(item))"
          [attr.r]="item.__meta?.kind === 'monthly' ? 5 : 6"
          [attr.fill]="getPointFill(item, $index)"
          class="has-tooltip"
          (mouseenter)="onPointHover($event, item, $index)"
          (mouseleave)="hideTooltip()"
          (click)="onPointClick(item, $event)"
          (touchstart)="onPointClick(item, $event)"
        />
      }
    </svg>
  </div>
</div>

<!-- Tooltip -->
@if (showTooltip) {
  <div class="chart-tooltip" #tooltip [style.left.px]="tooltipX" [style.top.px]="tooltipY">
    {{ tooltipText }}
  </div>
}

<!-- Legendas abaixo (período / mês / semana) -->
@if (getPeriodCaption()) {
  <div class="month-label">{{ getPeriodCaption() }}</div>
}
@if (viewMode === 'monthDetail' && getSelectedMonthLabel()) {
  <div class="month-label">{{ getSelectedMonthCaptionWithTotal() }}</div>
}
@if (selectedPeriod === '1 mês' && viewMode !== 'weekDetail') {
  <div class="month-label">{{ getMonthWindowCaptionWithTotal() }}</div>
}
@if (getWeekCaption()) {
  <div class="month-label">{{ getWeekCaption() }}</div>
}

<!-- Painel de alimentos do dia abaixo do gráfico -->
@if (showHistoricalPopup) {
  <div class="history-panel">
    <h3 i18n>Alimentos – {{ historicalDate }}</h3>

    @if (hasHistoricalFoods) {
      <ul class="food-list">
        @for (food of historicalFoods; track $index) {
          <li>
            {{ food.description }} — {{ food.grams }} g
          </li>
        }
      </ul>
    } @else {
      <p class="no-foods">Nenhum alimento registrado nesse dia.</p>
    }
  </div>
}
